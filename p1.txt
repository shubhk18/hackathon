#!/bin/bash

# Set database connection details
DB_USER="your_username"
DB_PASS="your_password"
DB_SID="your_db_sid"
DB_HOST="your_db_host"
DB_PORT="1521"  # Default Oracle port
DB_SERVICE="your_db_service"

# SQL query to extract multiple columns, including xml_blob
SQL_QUERY="SELECT id, name, 
                  UTL_RAW.CAST_TO_VARCHAR2(DBMS_LOB.SUBSTR(xml_blob, 4000, 1)) AS xml_data
            FROM xml_data_table;"

# Execute SQLPlus and capture the output in a variable
RESULT=$(sqlplus -S $DB_USER/$DB_PASS@$DB_HOST:$DB_PORT/$DB_SERVICE <<EOF
SET LINESIZE 32000
SET PAGESIZE 0
SET LONG 100000
SET LONGCHUNKSIZE 100000
SET HEADING OFF
SET FEEDBACK OFF
$SQL_QUERY
EOF
)

# Loop through each line of the result (each row)
echo "$RESULT" | while IFS=" " read -r ID NAME XML_DATA
do
    # Process each row
    echo "Processing Row: ID=$ID, Name=$NAME"
    
    # Optionally, handle XML data (e.g., save to a file, or process)
    echo "$XML_DATA" > "extracted_xml_$ID.xml"
    echo "XML Data for ID=$ID extracted to extracted_xml_$ID.xml"
done