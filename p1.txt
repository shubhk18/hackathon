#!/bin/bash

# Input parameters
input_file=$1      # The XML file with multiple ISO 20022 payment records
output_dir=$2      # Directory where individual XML files will be copied
delay=5            # Delay in seconds between each copy

# Check if input parameters are provided
if [[ -z "$input_file" || -z "$output_dir" ]]; then
    echo "Usage: $0 <input_file> <output_dir>"
    exit 1
fi

# Create output directory if it doesn't exist
mkdir -p "$output_dir"

# Variables
record_num=1
temp_dir="temp_records"
mkdir -p "$temp_dir"

# Split XML records using the <Document> tag
echo "Splitting ISO 20022 payment records from $input_file..."

# Use csplit to split the file at each <Document> tag
csplit -z -f "$temp_dir/record_" "$input_file" '/<Document>/' '{*}'

# Loop through each split file and move with delay
for record_file in "$temp_dir/record_"*; do
    # Skip empty files
    if [[ ! -s "$record_file" ]]; then
        continue
    fi

    # Define destination file path
    dest_file="$output_dir/payment_record_$record_num.xml"
    
    # Move the split file to output directory
    echo "Moving $record_file to $dest_file..."
    mv "$record_file" "$dest_file"

    # Verify if file was moved correctly
    if [[ -f "$dest_file" ]]; then
        echo "File payment_record_$record_num.xml moved successfully."
    else
        echo "Error: File payment_record_$record_num.xml was not moved correctly."
    fi

    # Increment record number and delay
    record_num=$((record_num + 1))
    sleep "$delay"
done

# Cleanup temporary files directory
rmdir "$temp_dir"
echo "Process completed."