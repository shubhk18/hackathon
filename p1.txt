#!/bin/bash

# Input parameters
input_file=$1      # The XML file with multiple ISO 20022 payment records
output_dir=$2      # Directory where individual XML files will be copied
delay=5            # Delay in seconds between each copy

# Check if input parameters are provided
if [[ -z "$input_file" || -z "$output_dir" ]]; then
    echo "Usage: $0 <input_file> <output_dir>"
    exit 1
fi

# Create output directory if it doesn't exist
mkdir -p "$output_dir"

# Variables
record_num=1
temp_file="$output_dir/temp_record.xml"

# Use awk to split at <Document> tags
echo "Splitting ISO 20022 payment records from $input_file..."

awk '
/<Document>/ { 
    if (out) close(out);               # Close previous file if open
    out = sprintf("'"$output_dir"'/payment_record_%d.xml", ++i) 
}
{ print > out }
' "$input_file"

# Process each file with a delay
for record_file in "$output_dir"/payment_record_*.xml; do
    # Verify if file was created
    if [[ -f "$record_file" ]]; then
        echo "File $(basename "$record_file") created successfully."
    else
        echo "Error: File $(basename "$record_file") was not created correctly."
    fi

    # Delay for MQ processing
    sleep "$delay"
done

echo "Process completed."